package com.hirehub.backend.freelancerprofile.repository;

import com.hirehub.backend.common.test.BaseIntegrationTest;
import com.hirehub.backend.freelancerprofile.domain.FreelancerProfile;
import com.hirehub.backend.user.domain.Role;
import com.hirehub.backend.user.domain.User;
import com.hirehub.backend.user.repository.UserRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.test.context.ActiveProfiles;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;

@DataJpaTest
@ActiveProfiles("test")
class FreelancerProfileRepositoryTest {
    @Autowired
    private FreelancerProfileRepository freelancerProfileRepository;
    
    @Autowired
    private UserRepository userRepository;

    @Test
    @DisplayName("Should find profile when user exists")
    void shouldFindProfileWhenUserExists() {
        User user = new User("Free", "free@example.com", null, Role.FREELANCER, "pass");
        user = userRepository.save(user);
        
        FreelancerProfile profile = new FreelancerProfile(user, "Professional Bio", "Java, Spring Boot", 50.0);
        profile = freelancerProfileRepository.save(profile);

        Optional<FreelancerProfile> result = freelancerProfileRepository.findByUser(user);

    
        assertTrue(result.isPresent(), "Profile should be found");
        FreelancerProfile foundProfile = result.get();
        assertEquals(profile.getId(), foundProfile.getId(), "Profile ID should match");
        assertEquals(profile.getBio(), foundProfile.getBio(), "Bio should match");
        assertEquals(profile.getSkills(), foundProfile.getSkills(), "Skills should match");
        assertEquals(profile.getHourlyRate(), foundProfile.getHourlyRate(), "Hourly rate should match");
        assertEquals(user.getId(), foundProfile.getUser().getId(), "User ID should match");
    }

    @Test
    @DisplayName("Should return empty when user has no profile")
    void shouldReturnEmptyWhenUserHasNoProfile() {
        // Arrange
        User user = new User("Free", "free@example.com", null, Role.FREELANCER, "pass");
        user = userRepository.save(user);

        // Act
        Optional<FreelancerProfile> result = freelancerProfileRepository.findByUser(user);

        // Assert
        assertFalse(result.isPresent(), "No profile should be found");
    }

    @Test
    @DisplayName("Should save profile with all fields")
    void shouldSaveProfileWithAllFields() {
        // Arrange
        User user = new User("Free", "free@example.com", null, Role.FREELANCER, "pass");
        user = userRepository.save(user);
        
        FreelancerProfile profile = new FreelancerProfile(user, "Professional Bio", "Java, Spring Boot", 50.0);

        // Act
        FreelancerProfile savedProfile = freelancerProfileRepository.save(profile);

        // Assert
        assertNotNull(savedProfile.getId(), "Profile should have an ID after saving");
        assertEquals(profile.getBio(), savedProfile.getBio(), "Bio should match");
        assertEquals(profile.getSkills(), savedProfile.getSkills(), "Skills should match");
        assertEquals(profile.getHourlyRate(), savedProfile.getHourlyRate(), "Hourly rate should match");
        assertEquals(user.getId(), savedProfile.getUser().getId(), "User ID should match");
    }
}
}